<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stone, Paper, Silicon</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Stone, Paper, Silicon</h1>
            <p class="subtitle">Your personal archive of human history - shared with others</p>
            <div class="view-tabs">
                <button class="view-tab active" data-view="timeline">Timeline</button>
                <button class="view-tab" data-view="map">World Map</button>
                <button class="view-tab" data-view="quiz">Quiz</button>
                <button class="view-tab" data-view="about">About</button>
                <button class="view-tab" data-view="takeaways" style="display: none;">Takeaways</button>
            </div>
        </header>

        <!-- Timeline View -->
        <div class="view-content timeline-view active" id="timelineView">

        <div class="controls">
            <div class="search-section">
                <input type="text" id="searchInput" placeholder="Search events..." autocomplete="off">
            </div>

            <div class="filter-section">
                <h3>Filter by Type</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-category="all">All</button>
                    <button class="filter-btn" data-category="period">Periods</button>
                    <button class="filter-btn" data-category="state">States</button>
                    <button class="filter-btn" data-category="religion">Religions</button>
                    <button class="filter-btn" data-category="culture">Cultures</button>
                    <button class="filter-btn" data-category="event">Events</button>
                </div>
            </div>

            <div class="scale-toggle">
                <label>
                    <input type="checkbox" id="experienceScale" checked>
                    Experience-based scaling
                </label>
            </div>

            <div class="zoom-controls">
                <button id="zoomOut">-</button>
                <input type="range" id="zoomSlider" min="0" max="100" step="1" value="24">
                <button id="zoomIn">+</button>
            </div>

            <div class="user-filter-dropdown">
                <button id="userFilterBtn" class="user-filter-btn" title="Filter by user">Users â–¾</button>
                <div id="userFilterMenu" class="user-filter-menu" style="display: none;">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <div class="data-controls">
                <button id="exportData" title="Export your data">Export CSV</button>
                <button id="importData" title="Import CSV data">Import CSV</button>
                <button id="sampleCsvBtn" title="Download sample CSV template">Sample CSV</button>
                <input type="file" id="importFile" accept=".csv" style="display: none;">
                <button id="changeNameBtn" title="Change display name" class="change-name-btn"></button>
            </div>
        </div>

        <div class="stats-bar">
            <span id="eventCount">0 events</span>
            <span id="timeRange"></span>
        </div>

        <div class="legend">
            <span class="legend-item"><span class="legend-color period"></span>Periods</span>
            <span class="legend-item"><span class="legend-color state"></span>States</span>
            <span class="legend-item"><span class="legend-color religion"></span>Religions</span>
            <span class="legend-item"><span class="legend-color culture"></span>Cultures</span>
            <span class="legend-item"><span class="legend-color event"></span>Events</span>
        </div>

        <div class="tag-filter-bar" id="tagFilterBar"></div>

        <div class="timeline-scale" id="timelineScale">
            <div class="scale-markers"></div>
        </div>
        <div class="timeline-container">
            <div class="timeline-content" id="timelineContent">
                <!-- Timeline regions will be rendered here -->
            </div>
        </div>

        <div class="event-detail-panel" id="eventDetailPanel">
            <button class="close-panel" id="closePanel">&times;</button>

            <div class="event-edit-fields">
                <label>
                    Title
                    <input type="text" id="eventTitle">
                </label>

                <div class="event-year-row">
                    <label>
                        Year
                        <input type="number" id="eventYear">
                    </label>
                    <label>
                        End Year
                        <input type="number" id="eventEndYear" placeholder="Optional">
                    </label>
                </div>

                <label>
                    Type
                    <div class="category-selector">
                        <span class="category-color-preview" id="categoryColorPreview"></span>
                        <select id="eventCategorySelect">
                            <option value="event">Event</option>
                            <option value="state">State</option>
                            <option value="religion">Religion</option>
                            <option value="culture">Culture</option>
                            <option value="period">Period</option>
                        </select>
                    </div>
                </label>

                <label>
                    Region
                    <select id="eventRegionSelect">
                        <option value="subsaharan-africa">Subsaharan Africa</option>
                        <option value="europe-middle-east">Europe & Middle East</option>
                        <option value="asia">Asia</option>
                        <option value="americas">The Americas</option>
                        <option value="pacific">Pacific</option>
                    </select>
                </label>

                <label>
                    Description
                    <textarea id="eventDescription" rows="3"></textarea>
                </label>
            </div>

            <div class="event-added-by" id="eventAddedBy" style="display: none;"></div>
            <button id="joinEventBtn" class="join-event-btn" style="display: none;">Join This Event</button>

            <div class="event-tags-section" id="eventTagsSection" style="display: none;">
                <h4>Tags</h4>
                <div class="event-tags-display" id="eventTagsDisplay"></div>
                <div class="tag-checkboxes tag-checkboxes-edit" id="eventTagsEdit"></div>
            </div>

            <div class="event-notes" id="eventNotes">
                <h4>My Notes</h4>
                <textarea id="notesInput" placeholder="Add your notes here..."></textarea>
            </div>

            <button id="saveEventEditsBtn" class="save-edits-btn">Save</button>

            <div class="event-references" id="eventReferences">
                <h4>References</h4>
                <ul id="referencesList"></ul>
                <button id="addReference">+ Add Reference</button>
            </div>

            <div class="event-danger-zone">
                <button id="deleteEventBtn" class="delete-event-btn">Delete Event</button>
            </div>
        </div>

        <div class="add-event-modal" id="addEventModal">
            <div class="modal-content">
                <h2>Add New Event</h2>
                <form id="addEventForm">
                    <label>
                        Title
                        <input type="text" id="newEventTitle" required>
                    </label>
                    <label>
                        Year (negative for BCE)
                        <input type="number" id="newEventYear" required>
                    </label>
                    <label>
                        End Year (optional, for periods)
                        <input type="number" id="newEventEndYear">
                    </label>
                    <label>
                        Region
                        <select id="newEventRegion" required>
                            <option value="subsaharan-africa">Subsaharan Africa</option>
                            <option value="europe-middle-east">Europe & Middle East</option>
                            <option value="asia">Asia</option>
                            <option value="americas">The Americas</option>
                            <option value="pacific">Pacific</option>
                        </select>
                    </label>
                    <label>
                        Type
                        <select id="newEventCategory">
                            <option value="event">Event</option>
                            <option value="state">State</option>
                            <option value="religion">Religion</option>
                            <option value="culture">Culture</option>
                            <option value="period">Period</option>
                        </select>
                    </label>
                    <label>Tags (optional)</label>
                    <div class="tag-checkboxes" id="newEventTags"></div>
                    <label>
                        Description
                        <textarea id="newEventDescription"></textarea>
                    </label>
                    <label>
                        Source URL (optional)
                        <input type="url" id="newEventSourceUrl" placeholder="https://...">
                    </label>
                    <div class="modal-buttons">
                        <button type="button" id="cancelAddEvent">Cancel</button>
                        <button type="submit">Add Event</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="add-reference-modal" id="addReferenceModal">
            <div class="modal-content">
                <h2>Add Reference</h2>
                <form id="addReferenceForm">
                    <label>
                        Type
                        <select id="refType">
                            <option value="book">Book</option>
                            <option value="article">Article</option>
                            <option value="podcast">Podcast</option>
                            <option value="video">Video</option>
                            <option value="other">Other</option>
                        </select>
                    </label>
                    <label>
                        Title
                        <input type="text" id="refTitle">
                    </label>
                    <label>
                        URL (Goodreads, Spotify, etc.)
                        <input type="url" id="refUrl">
                    </label>
                    <label>
                        Status
                        <select id="refStatus">
                            <option value="to-read">To Read/Watch/Listen</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </label>
                    <div class="modal-buttons">
                        <button type="button" id="cancelAddReference">Cancel</button>
                        <button type="submit">Add Reference</button>
                    </div>
                </form>
            </div>
        </div>

        <button class="add-event-btn" id="addEventBtn">+ Add Event</button>

        </div> <!-- End Timeline View -->

        <!-- Map View -->
        <div class="view-content map-view" id="mapView">
            <div class="map-controls">
                <div class="map-time-control">
                    <button id="mapPrevEra" class="map-nav-btn" title="Previous Era">&lt;&lt;</button>
                    <button id="mapPlayBtn" class="map-play-btn">Play</button>
                    <button id="mapNextEra" class="map-nav-btn" title="Next Era">&gt;&gt;</button>
                    <div class="map-year-display">
                        <span id="mapYearDisplay">1 CE</span>
                    </div>
                    <input type="range" id="mapYearSlider" min="0" max="1000" value="500" class="map-slider">
                    <div class="map-speed-control">
                        <label>Speed:</label>
                        <select id="mapSpeed">
                            <option value="1">Slow</option>
                            <option value="2" selected>Medium</option>
                            <option value="3">Fast</option>
                        </select>
                    </div>
                    <div class="map-scale-toggle">
                        <label>
                            <input type="checkbox" id="mapExperienceScale">
                            People-years scale
                        </label>
                    </div>
                    <div class="map-scale-toggle">
                        <label>
                            <input type="checkbox" id="mapCuratedToggle">
                            Show curated empires
                        </label>
                    </div>
                </div>
            </div>

            <div class="map-main">
                <div class="map-sidebar">
                    <h3>Active Empires</h3>
                    <div id="activeEmpiresList" class="empire-list"></div>
                </div>
                <div class="map-container-wrapper">
                    <div id="mapContainer" class="map-container"></div>
                    <div id="mapLoading" class="map-loading" style="display: none;">
                        <div class="map-loading-spinner"></div>
                        <span>Loading map data...</span>
                    </div>
                </div>
            </div>
        </div> <!-- End Map View -->

        <!-- Quiz View -->
        <div class="view-content quiz-view" id="quizView">
            <div class="quiz-container">
                <div class="quiz-header">
                    <div class="quiz-settings">
                        <div class="quiz-difficulty">
                            <label>Difficulty:</label>
                            <select id="quizDifficulty">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate" selected>Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="quiz-source">
                            <label>Questions from:</label>
                            <select id="quizSource">
                                <option value="all">All Events</option>
                                <option value="user">My Added Events</option>
                                <option value="references">My References</option>
                            </select>
                        </div>
                        <div class="quiz-count">
                            <label>Questions:</label>
                            <select id="quizCount">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                        <button id="startQuizBtn" class="quiz-start-btn">Start Quiz</button>
                    </div>
                    <div class="quiz-score" id="quizScore" style="display: none;">
                        <span class="score-label">Score:</span>
                        <span class="score-value" id="quizScoreValue">0</span>
                        <span class="score-divider">/</span>
                        <span class="score-total" id="quizScoreTotal">0</span>
                    </div>
                </div>

                <div class="quiz-progress" id="quizProgress" style="display: none;">
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" id="quizProgressFill"></div>
                    </div>
                    <span class="quiz-progress-text" id="quizProgressText">Question 1 of 10</span>
                </div>

                <div class="quiz-welcome" id="quizWelcome">
                    <h2>Test Your History Knowledge</h2>
                    <p>Generate quiz questions based on your timeline data. Questions are tailored to events you've added and references you've read.</p>
                    <div class="quiz-stats" id="quizStats"></div>
                </div>

                <div class="quiz-question-card" id="quizCard" style="display: none;">
                    <div class="quiz-question-type" id="quizQuestionType"></div>
                    <h3 class="quiz-question-text" id="quizQuestionText"></h3>
                    <div class="quiz-answers" id="quizAnswers"></div>
                    <div class="quiz-feedback" id="quizFeedback" style="display: none;">
                        <p id="quizFeedbackText"></p>
                        <button id="quizNextBtn" class="quiz-next-btn">Next Question</button>
                    </div>
                </div>

                <div class="quiz-results" id="quizResults" style="display: none;">
                    <h2>Quiz Complete!</h2>
                    <div class="quiz-results-score" id="quizResultsScore"></div>
                    <div class="quiz-results-breakdown" id="quizResultsBreakdown"></div>
                    <button id="quizRetryBtn" class="quiz-start-btn">Try Again</button>
                </div>

                <div class="quiz-history" id="quizHistory">
                    <h3>Recent Quizzes</h3>
                    <div id="quizHistoryList" class="quiz-history-list"></div>
                </div>
            </div>
        </div> <!-- End Quiz View -->

        <!-- Takeaways View -->
        <div class="view-content takeaways-view" id="takeawaysView">
            <div class="takeaways-container">
                <div class="takeaways-header">
                    <h2>My History Takeaways</h2>
                    <p class="takeaways-subtitle">Record your key insights and learnings about history</p>
                </div>

                <div class="takeaway-editor">
                    <textarea id="takeawayInput" placeholder="Write a new takeaway... What patterns do you see? What surprised you? What connections have you made?" rows="3"></textarea>
                    <div class="takeaway-editor-controls">
                        <div class="takeaway-tags">
                            <label>Link to:</label>
                            <select id="takeawayEntitySelect">
                                <option value="">General (no specific topic)</option>
                            </select>
                        </div>
                        <button id="addTakeawayBtn" class="takeaway-add-btn">Add Takeaway</button>
                    </div>
                </div>

                <div class="takeaways-list" id="takeawaysList"></div>
            </div>
        </div> <!-- End Takeaways View -->

        <!-- About View -->
        <div class="view-content about-view" id="aboutView">
            <div class="about-container">
                <h2>About Stone, Paper, Silicon</h2>
                <p class="about-intro">A shared tool for exploring and recording human history. Add events, track empires, quiz yourself, and collaborate with others.</p>

                <div class="about-section">
                    <h3>Timeline</h3>
                    <p>The main view shows historical events, states, religions, cultures, and periods laid out across time. Use the filters at the top to show specific categories, and the tag bar to filter by subtypes like war, science, or trade.</p>
                    <p>Click any event bar to view details, edit it, add notes, or attach references. You can drag events vertically to rearrange rows, and use the zoom controls or mouse wheel (Ctrl+scroll) to zoom in and out.</p>
                    <p>Use "Export CSV" to save your timeline data and "Import CSV" to load events from a spreadsheet. The "Sample CSV" button downloads a template you can fill in.</p>
                </div>

                <div class="about-section">
                    <h3>World Map</h3>
                    <p>The map view shows historical borders from GeoJSON basemaps. Use the time slider or play button to scrub through history and watch empires rise and fall.</p>
                    <p>Click any territory on the map to see its details. If it matches a known entity, you can add it directly to your timeline. For unrecognized territories, use "Create State Entity" to define a new entity.</p>
                    <p>The sidebar lists all active territories for the current time period. Linked entities (already in your timeline) are written in red.</p>
                </div>

                <div class="about-section">
                    <h3>Quiz</h3>
                    <p>Test your knowledge with auto-generated questions based on your timeline data. Choose difficulty (beginner, intermediate, advanced) and the source of questions (all events, your added events, or events linked to your references).</p>
                    <p>Question types include: date questions ("When did X happen?"), identification ("What happened around year X?"), chronology ("Which came first?"), true/false, and entity identification.</p>
                </div>

                <div class="about-section">
                    <h3>Multi-user functionality</h3>
                    <p>Events you create are tagged with your name. Use the "Users" dropdown to filter the timeline by contributor. Click "Join" on another user's event to add it to your own collection.</p>
                </div>

                <div class="about-section">
                    <h3>A note on time-scales</h3>
                    <p>This timeline includes a "People-years scale" toggle that changes how time is distributed across the horizontal axis. Instead of spacing years evenly, it weights them by how much lived human experience they contain.</p>
                    <p>The idea is simple: a calendar year in 2025 contains far more human life than a year in 100,000 BCE, because today's population is thousands of times larger. On a traditional timeline, 300,000 years of prehistory dwarfs everything else. But those millennia, lived by small populations, contain roughly the same amount of cumulative experience that humanity now accumulates in just 25 years. The people-years scale compresses that long, sparsely populated past and expands the densely populated recent centuries, giving a more accurate picture of where human experience actually concentrates.</p>
                    <p>For more on this idea, see <a href="https://www.noidlesitting.com/p/a-timeline-of-human-experience" target="_blank">A Timeline of Human Experience</a>.</p>
                </div>

                <div class="about-section">
                    <h3>Feedback and feature requests</h3>
                    <p>I am hungry for feedback! If you catch bugs or have feature requests, chances are I can implement them quite quickly. Feel free to DM me, leave a comment on <a href="https://www.noidlesitting.com" target="_blank">my blog</a>, or <a href="https://github.com/ljeure/stone-paper-silicon/issues" target="_blank">create a GitHub issue</a>.</p>
                </div>
            </div>
        </div> <!-- End About View -->

        <!-- Empire Detail Modal (for Map) -->
        <div class="empire-detail-modal" id="empireDetailModal">
            <div class="modal-content empire-modal-content">
                <button class="close-modal" id="closeEmpirePanel">&times;</button>
                <h2 id="empireTitle"></h2>
                <p class="empire-dates" id="empireDates"></p>

                <!-- Info section (shown when not in timeline) -->
                <div id="empireInfoSection">
                    <p class="empire-description" id="empireDescription"></p>
                    <div id="geoInfoSection" class="geo-info-section" style="display: none;"></div>
                </div>

                <!-- Edit section (shown when in timeline) -->
                <div id="empireEditSection" style="display: none;">
                    <div class="empire-edit-form">
                        <label>
                            Title
                            <input type="text" id="editEmpireTitle">
                        </label>
                        <div class="form-row">
                            <label>
                                Start Year
                                <input type="number" id="editEmpireStartYear">
                            </label>
                            <label>
                                End Year
                                <input type="number" id="editEmpireEndYear">
                            </label>
                        </div>
                        <label>
                            Type
                            <select id="editEmpireCategory">
                                <option value="state">State</option>
                                <option value="religion">Religion</option>
                                <option value="culture">Culture</option>
                                <option value="period">Period</option>
                                <option value="event">Event</option>
                            </select>
                        </label>
                        <label>
                            Region
                            <select id="editEmpireRegion">
                                <option value="subsaharan-africa">Subsaharan Africa</option>
                                <option value="europe-middle-east">Europe & Middle East</option>
                                <option value="asia">Asia</option>
                                <option value="americas">The Americas</option>
                                <option value="pacific">Pacific</option>
                            </select>
                        </label>
                        <label>
                            Description
                            <textarea id="editEmpireDescription" rows="3"></textarea>
                        </label>
                    </div>
                </div>

                <div class="empire-actions">
                    <button id="addEmpireToTimeline" class="add-to-timeline-btn">Add to Timeline</button>
                    <button id="createStateEntity" class="create-entity-btn" style="display: none;">Create State Entity</button>
                    <button id="saveEmpireEdits" class="save-edits-btn" style="display: none;">Save Changes</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Leaflet JS for Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="data.js"></script>
    <script src="map-data.js"></script>
    <script src="map.js"></script>
    <script src="quiz.js"></script>
    <script src="app.js"></script>
</body>
</html>
